---
title: "SumScore_imp"
author: "Haotian Zheng"
date: "2024-07-23"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mice)
library(dplyr)
library(ggplot2)
library(micemd)
library(countimp)
library(miceRanger)
library(remote)
```



get data
```{r}
data = read.csv("data.csv")
```



imputation
```{r}
ini = mice(data, max = 0, print = FALSE)
meth = ini$meth
meth["x1"] = "rf"
meth["x_sum"] = "~I(x1 + x2 + x3)"
meth["x2"] = "pmm"
meth["x3"] = "midastouch" # when dataset is very large, "midastouch" will be very slow
pred = ini$pred
pred["x_sum", ] = 0
pred[c("x1", "x2", "x3"), "x_sum"] = 0
pred[c("x1", "x2", "x3"), c("z1", "z2", "z3")] = 0
pred[c("z1", "z2", "z3"), c("x1", "x2", "x3")] = 0
post = make.post(data)
post["x1"] = "imp[[j]][, i] = squeeze(imp[[j]][, i], c(-18, 18))"
post["x2"] = "imp[[j]][, i] = squeeze(imp[[j]][, i], c(0, 7))"
post["x3"] = "imp[[j]][, i] = squeeze(imp[[j]][, i], c(1, 3))"
post["x_sum"] = "ifdo(c(x_sum < -17, x_sum > 52), c(-17, 52))"
imp.sum = mice(data, pred = pred, meth = meth, post = post, maxit = 20, M = M, seed = 1018)
```



regression
```{r}
beta_true = summary(lm(y ~ x_sum + z1 + z2 + z3, data = data_raw))$coefficients[, "Estimate"]

beta_imp = c()
for (i in 1: M) {
  df_imp = complete(imp.sum, i)
  beta_imp = rbind(beta_imp,
    summary(lm(y ~ x_sum + z1 + z2 + z3, data = df_imp))$coefficients[, "Estimate"])
}
print(colMeans(beta_imp))
print(beta_true)
```



diagnostics
```{r}
plot(imp.sum)
densityplot(imp.sum)
```



MCAR missing type
```{r}
data = introduce_missingness(data_raw, "MCAR", "x1", 0.3)
data = introduce_missingness(data, "MCAR", "x2", 0.7)
data = introduce_missingness(data, "MCAR", "x3", 0.995)
data = introduce_missingness(data, "MCAR", "z1", 0.9)
data$x_sum = data$x1 + data$x2 + data$x3
```



imputation
```{r}
ini = mice(data, max = 0, print = FALSE)
meth = ini$meth
meth["x1"] = "rf"
meth["x_sum"] = "~I(x1 + x2 + x3)"
meth["x2"] = "pmm"
meth["x3"] = "midastouch" # when dataset is very large, "midastouch" will be very slow
pred = ini$pred
pred["x_sum", ] = 0
pred[c("x1", "x2", "x3"), "x_sum"] = 0
pred[c("x1", "x2", "x3"), c("z1", "z2", "z3")] = 0
pred[c("z1", "z2", "z3"), c("x1", "x2", "x3")] = 0
post = make.post(data)
post["x1"] = "imp[[j]][, i] = squeeze(imp[[j]][, i], c(-18, 18))"
post["x2"] = "imp[[j]][, i] = squeeze(imp[[j]][, i], c(0, 7))"
post["x3"] = "imp[[j]][, i] = squeeze(imp[[j]][, i], c(1, 3))"
post["x_sum"] = "ifdo(c(x_sum < -17, x_sum > 52), c(-17, 52))"
imp.sum = mice(data, pred = pred, meth = meth, post = post, maxit = 20, M = M, seed = 1018)
```



regression
```{r}
beta_true = summary(lm(y ~ x_sum + z1 + z2 + z3, data = data_raw))$coefficients[, "Estimate"]

beta_imp = c()
for (i in 1: M) {
  df_imp = complete(imp.sum, i)
  beta_imp = rbind(beta_imp,
    summary(lm(y ~ x_sum + z1 + z2 + z3, data = df_imp))$coefficients[, "Estimate"])
}
print(colMeans(beta_imp))
print(beta_true)
```



diagnostics
```{r}
plot(imp.sum)
densityplot(imp.sum)
```



